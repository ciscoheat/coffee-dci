(function(){var c={}.hasOwnProperty,b=function(d,g){for(var f in g){if(c.call(g,f)){d[f]=g[f]}}function e(){this.constructor=d}e.prototype=g.prototype;d.prototype=new e();d.__super__=g.prototype;return d},a=function(d,e){return function(){return d.apply(e,arguments)}};describe("Ivento.Dci.Context",function(){var d,g,e,f;d=(function(h){b(i,h);function i(j){if(j==null){j=[]}this.bind(j).to(this.ledgers)}i.prototype.ledgers={addEntry:function(k,j){return this.push({message:k,amount:j})},getBalance:function(){return this.reduce((function(k,j){return k+j.amount}),0)}};i.prototype.balance=function(){return this.ledgers.getBalance()};i.prototype.increaseBalance=function(j){return this.ledgers.addEntry("Depositing",j)};i.prototype.decreaseBalance=function(j){return this.ledgers.addEntry("Withdrawing",-j)};return i})(Ivento.Dci.Context);g=(function(){function h(i){Ivento.Dci.Context.bind(this,{entries:i}).to(this.ledgers)}h.prototype.ledgers={getBalance:function(){return this.entries.reduce((function(j,i){return j+i.amount}),0)}};h.prototype.balance=function(){return this.ledgers.getBalance()};return h})();e=null;f=null;beforeEach(function(){f=[{message:"Start",amount:100},{message:"First deposit",amount:1000}];return e=new d(f)});describe("Binding behaviour",function(){it("should bind objects to roles using the bind() method",function(){expect(e.ledgers).toBe(f);return expect(e.ledgers.getBalance()).toEqual(1100)});it("should be able to use the context methods",function(){return expect(e.balance()).toEqual(e.ledgers.getBalance())});it("should modify the rolePlayers correctly",function(){expect(e.ledgers).toBe(f);expect(e.ledgers.length).toBe(2);e.increaseBalance(200);expect(e.ledgers).toBe(f);expect(e.ledgers.length).toBe(3);expect(e.ledgers[2]).toEqual({message:"Depositing",amount:200});expect(e.balance()).toEqual(1300);e.decreaseBalance(1500);expect(e.balance()).toEqual(-200);return expect(e.ledgers[3]).toEqual({message:"Withdrawing",amount:-1500})});return it("should bind to objects not using inheritance with the static method.",function(){var h;h=new g(f);return expect(h.balance()).toEqual(1100)})});describe("MoneyTransfer Context",function(){var h;h=(function(i){b(j,i);function j(m,l,k){this.bind(m).to(this.source);this.bind(l).to(this.destination);this.bind(k).to(this.amount)}j.prototype.source={withdraw:function(k){return this.decreaseBalance(k)},transfer:function(k){this.context.destination.deposit(k);return this.withdraw(k)}};j.prototype.destination={deposit:function(k){return this.increaseBalance(k)}};j.prototype.amount={};j.prototype.transfer=function(){return this.source.transfer(this.amount)};return j})(Ivento.Dci.Context);return it("should transfer money using Accounts",function(){var i,j,k,l;l=new d(f);k=new d;i=200;expect(l.balance()).toEqual(1100);expect(k.balance()).toEqual(0);j=new h(l,k,i);j.transfer();j.unbind();expect(l.balance()).toEqual(900);return expect(k.balance()).toEqual(200)})});describe("Role Contracts",function(){var h;h=(function(i){b(j,i);function j(k,l){this.bind(k).to(this.guests);this.bind(l).to(this.waiter)}j.prototype.waiter={_contract:["name"],greetGuests:function(){return"Welcome, my name is "+this.name+", I'll be your waiter tonight."}};j.prototype.guests={_contract:["add","remove"]};return j})(Ivento.Dci.Context);it("should ensure that the RolePlayer has all contract properties in the _contract array",function(){var i,j,k;k={name:"Henry"};j=[];j.add=j.push;j.remove=function(l){return delete this[l]};i=new h(j,k);expect(i.waiter.greetGuests()).toEqual("Welcome, my name is Henry, I'll be your waiter tonight.");return expect(i.guests.add("Someone")).toEqual(1)});return it("should throw an Exception if the RolePlayer doesn't have all the properties in the _contract array",function(){var i,j;i={};j=[];j.add=j.push;j.remove=function(k){return delete this[k]};return expect(function(){return new h(j,i)}).toThrow("RolePlayer [object Object] didn't fulfill Role Contract with property 'name'.")})});describe("Role method accessing behavior for name conflicts",function(){var h,i,j;i=(function(k){b(l,k);function l(m){this.bind(m).to(this.player)}l.prototype.player={_contract:["bar"],foo:function(){return"Role method foo"}};l.prototype.play=function(){return this.player.bar()};l.prototype.playFoo=function(){return this.player.foo()};return l})(Ivento.Dci.Context);j=(function(k){b(l,k);function l(m){this.bind(m).to(this.account)}l.prototype.account={_contract:["amount","save","write"],transfer:function(){this.save();return this.write()},write:function(){return this.logWritten=true}};l.prototype.transfer=function(){return this.account.transfer()};return l})(Ivento.Dci.Context);h=(function(){function k(l){this.amount=l;this.write=a(this.write,this);this.validate=a(this.validate,this);this.save=a(this.save,this)}k.prototype.save=function(){if(this.validate()){return this.write()}};k.prototype.validate=function(){return this.amount>0};k.prototype.write=function(){return this.dbWritten=true};return k})();it("should call the instance method of object.foo even if the object has a role.foo method defined, if called outside the context",function(){var k,l;l={foo:function(){return"Object method foo"},bar:function(){return this.foo()}};k=new i(l);expect(k.play()).toEqual("Object method foo");return expect(k.playFoo()).toEqual("Role method foo")});return it("should call the role method role.foo even if the object has a object.foo defined, if called inside the context",function(){var k,l;k=new h(123);l=new j(k);expect(k.logWritten).toBeFalsy();expect(k.dbWritten).toBeFalsy();l.transfer();expect(k.logWritten).toBeTruthy();return expect(k.dbWritten).toBeTruthy()})});return describe("Unbinding behavior",function(){var i,k,h,j;h=null;j=null;beforeEach(function(){return h={name:"Clark Kent",useXRay:function(){return"Prevented by glasses."}}});i=(function(l){b(m,l);function m(n){}m.prototype.spiderman={useWeb:function(){return"fzzzt!"}};return m})(Ivento.Dci.Context);k=(function(l){b(m,l);function m(n){this.bind(n).to(this.superman)}m.prototype.superman={useXRay:function(){return"wzzzt!"},fly:function(){expect(this).toBe(h);return"wheee!"}};m.prototype.execute=function(){expect(this).toBe(j);return this.superman.fly()};m.prototype.xRay=function(){return this.superman.useXRay()};return m})(Ivento.Dci.Context);it("should have an unbind method added after the first bind",function(){var l;l=new i(h);expect(l.unbind).toBeUndefined();j=new k(h);return expect(j.unbind).toBeDefined()});return it("should remove the role methods from the rolePlayer when calling unbind",function(){j=new k(h);expect(h.useXRay()).toEqual("Prevented by glasses.");expect(h.fly()).toEqual("wheee!");expect(j.superman.name).toBeDefined();expect(j.xRay()).toEqual("wzzzt!");j.unbind();expect(h.fly).toBeUndefined();expect(j.unbind).toBeUndefined();return expect(j.superman.name).toBeUndefined()})})})}).call(this);