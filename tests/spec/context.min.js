(function(){var c={}.hasOwnProperty,b=function(d,g){for(var f in g){if(c.call(g,f)){d[f]=g[f]}}function e(){this.constructor=d}e.prototype=g.prototype;d.prototype=new e();d.__super__=g.prototype;return d},a=function(d,e){return function(){return d.apply(e,arguments)}};describe("Ivento.Dci.Context",function(){var d,f,e;d=(function(g){b(h,g);function h(i){if(i==null){i=[]}this.bind(i).to("ledgers")}h.prototype.ledgers={_contract:["push","reduce"],addEntry:function(j,i){return this.push({message:j,amount:i})},getBalance:function(){return this.reduce((function(j,i){return j+i.amount}),0)}};h.prototype.balance=function(){return this.ledgers.getBalance()};h.prototype.increaseBalance=function(i){return this.ledgers.addEntry("Depositing",i)};h.prototype.decreaseBalance=function(i){return this.ledgers.addEntry("Withdrawing",-i)};return h})(Ivento.Dci.Context);f=(function(){function g(h){Ivento.Dci.Context.bind(this,{entries:h}).to("ledgers")}g.prototype.ledgers={_contract:["entries"],getBalance:function(){return this.entries.reduce((function(i,h){return i+h.amount}),0)}};g.prototype.balance=function(){return this.ledgers.getBalance()};return g})();e=null;beforeEach(function(){e=[{message:"Start",amount:100},{message:"First deposit",amount:1000}];return window.entries=e});describe("Binding behaviour",function(){var g;g=null;beforeEach(function(){return g=new d(e)});it("should bind objects to roles using the bind() method",function(){return expect(g.ledgers).toBeDefined()});it("should be able to use the context methods",function(){return expect(g.balance()).toEqual(1100)});it("should modify the rolePlayers correctly",function(){expect(e.length).toBe(2);g.increaseBalance(200);expect(e.length).toBe(3);expect(e[2]).toEqual({message:"Depositing",amount:200});expect(g.balance()).toEqual(1300);g.decreaseBalance(1500);expect(g.balance()).toEqual(-200);return expect(e[3]).toEqual({message:"Withdrawing",amount:-1500})});it("should bind to objects not using inheritance with the static method.",function(){var h;h=new f(e);return expect(h.balance()).toEqual(1100)});it("should throw an exception if the Role name isn't found in the Context",function(){var h;h=(function(i){b(j,i);function j(){this.bind(123).to("nonExistentRole")}return j})(Ivento.Dci.Context);return expect(function(){return new h}).toThrow("Role 'nonExistentRole' not found in Context.")});it("should throw an exception if the Role isn't bound as a string",function(){var h;h=(function(i){b(j,i);function j(){this.bind(123).to(this.role)}j.prototype.role={};return j})(Ivento.Dci.Context);return expect(function(){return new h}).toThrow("A Role must be bound as a string literal.")});return it("should be allowed to bind null to a Role",function(){var h;h=(function(i){b(j,i);function j(k){this.bind(k).to("role")}j.prototype.role={_contract:["test"]};j.prototype.test=function(){return this.role};return j})(Ivento.Dci.Context);return expect(new h(null).test()).toBeNull()})});describe("MoneyTransfer Context",function(){var g;g=(function(h){b(i,h);function i(l,k,j){this.bind(l).to("source");this.bind(k).to("destination");this.bind(j).to("amount")}i.prototype.source={_contract:["decreaseBalance"],withdraw:function(j){return this.decreaseBalance(j)},transfer:function(j){this.context.destination.deposit(j);return this.withdraw(j)}};i.prototype.destination={_contract:["increaseBalance"],deposit:function(j){return this.increaseBalance(j)}};i.prototype.amount={};i.prototype.transfer=function(){return this.source.transfer(this.amount)};return i})(Ivento.Dci.Context);return it("should transfer money using Accounts",function(){var h,i,j;j=new d(e);i=new d;expect(j.balance()).toEqual(1100);expect(i.balance()).toEqual(0);h=new g(j,i,200);h.transfer();expect(j.balance()).toEqual(900);return expect(i.balance()).toEqual(200)})});describe("Role Contracts",function(){var g;g=(function(h){b(i,h);function i(j,k){this.bind(j).to("guests");this.bind(k).to("waiter")}i.prototype.waiter={_contract:["name"],greetGuests:function(){return"Welcome, my name is "+this.name+", I'll be your waiter tonight."}};i.prototype.guests={_contract:["add","remove"]};i.prototype.greet=function(){return this.waiter.greetGuests()};i.prototype.addGuest=function(j){return this.guests.add(j)};return i})(Ivento.Dci.Context);it("should ensure that the RolePlayer has all contract properties in the _contract array",function(){var h,i,j;j={name:"Henry"};i=[];i.add=i.push;i.remove=function(k){return delete this[k]};h=new g(i,j);expect(h.greet()).toEqual("Welcome, my name is Henry, I'll be your waiter tonight.");return expect(h.addGuest("Someone")).toEqual(1)});it("should throw an Exception if the RolePlayer doesn't have all the properties in the _contract array",function(){var h,i;h={};i=[];i.add=i.push;i.remove=function(j){return delete this[j]};return expect(function(){return new g(i,h)}).toThrow("RolePlayer [object Object] didn't fulfill Role Contract with property 'name'.")});return it("should throw an Exception if the RolePlayer doesn't have the nested properties specified in the _contract array",function(){var i,h,j;i=(function(k){b(l,k);function l(m){this.bind(m).to("node")}l.prototype.node={_contract:["distance.from.east"]};return l})(Ivento.Dci.Context);j={distance:123};h={distance:{from:{east:123}}};expect(function(){return new i(j)}).toThrow("RolePlayer [object Object] didn't fulfill Role Contract with property 'distance.from.east'.");return expect(function(){return new i(h)}).not.toThrow()})});describe("Role method accessing behavior for name conflicts",function(){var g,h,i;i=(function(j){b(k,j);function k(l){this.bind(l).to("account")}k.prototype.account={_contract:["save","write"],transfer:function(){this.save();return this.write()},write:function(){return this.logWritten=true}};k.prototype.transfer=function(){return this.account.transfer()};return k})(Ivento.Dci.Context);g=(function(){function j(k){this.amount=k;this.write=a(this.write,this);this.validate=a(this.validate,this);this.save=a(this.save,this)}j.prototype.save=function(){if(this.validate()){return this.write()}};j.prototype.validate=function(){return this.amount>0};j.prototype.write=function(){return this.dbWritten=true};return j})();h=(function(j){b(k,j);function k(l){this.bind(l).to("player");this.bind(l).to("judge")}k.prototype.player={_contract:["bar"],foo:function(){return"Role method foo"}};k.prototype.judge={_contract:["foo"],judgeGame:function(){return"Judge: "+this.foo()}};k.prototype.play=function(){return this.player.bar()};k.prototype.playFoo=function(){return this.player.foo()};k.prototype.judgeGame=function(){return this.judge.judgeGame()};return k})(Ivento.Dci.Context);it("should call the instance method of object.foo even if the object has a role.foo method defined, if called outside the context",function(){var j,k;k={foo:function(){return"Object method foo"},bar:function(){return this.foo()}};j=new h(k);expect(j.play()).toEqual("Object method foo");expect(j.playFoo()).toEqual("Role method foo");expect(j.judgeGame()).toEqual("Judge: Object method foo");expect(k.foo()).toEqual("Object method foo");return expect(k.bar()).toEqual("Object method foo")});it("should call the role method role.foo even if the object has a object.foo defined, if called inside the context",function(){var j,k;j=new g(123);k=new i(j);expect(j.logWritten).toBeFalsy();expect(j.dbWritten).toBeFalsy();k.transfer();expect(j.logWritten).toBeTruthy();return expect(j.dbWritten).toBeTruthy()});return it("should throw an exception if multiple roles have the same role method name",function(){var j;j=(function(k){b(l,k);function l(m){if(m==null){m={}}this.bind(m).to("source");this.bind(m).to("target")}l.prototype.source={foo:function(){return"source"}};l.prototype.target={foo:function(){return"target"}};l.prototype.doIt=function(){return this.source.foo()+this.target.foo()};return l})(Ivento.Dci.Context);return expect(function(){return new j()}).toThrow("Method name conflict in Roles 'source.foo' and 'target.foo'. Please prepend the Role names to the methods to avoid conflict.")})});describe("Context access from Role methods",function(){var g,h;g=(function(i){b(j,i);function j(k){this.bind(k).to("R1");this.bind("C1").to("name")}j.prototype.R1={name:function(){return this+":"+this.context.name}};j.prototype.name={};j.prototype.getName=function(){var k,l;k=new h(this.R1);l=this.R1.name()+"/";l+=k.getName();return l+="/"+this.R1.name()};return j})(Ivento.Dci.Context);h=(function(i){b(j,i);function j(k){this.bind(k).to("R2");this.bind("C2").to("name")}j.prototype.R2={name:function(){return this+":"+this.context.name}};j.prototype.name={};j.prototype.getName=function(){return this.R2.name()};return j})(Ivento.Dci.Context);return it("should access the correct context and objects should keep identity",function(){var i;i={toString:function(){return"A"}};return expect(new g(i).getName()).toEqual("A:C1/A:C2/A:C1")})});describe("Role access from outside Context",function(){var g;g=(function(h){b(i,h);function i(j){this.bind(j).to("test")}i.prototype.test={inside:function(){return"inside"}};i.prototype.doIt=function(){return this.test.inside()};return i})(Ivento.Dci.Context);return it("should not be allowed",function(){var h,i;i={outside:function(){return"outside"}};h=new g(i);expect(h.test).toBeDefined();expect(function(){return h.test.inside()}).toThrow("Object #<Object> has no method 'inside'");expect(h.doIt()).toEqual("inside");return expect(function(){return h.test.inside()}).toThrow("Object #<Object> has no method 'inside'")})});describe("Asynchronous behavior",function(){var g,h;g=(function(i){b(j,i);function j(k){this.bind(k).to("ajax")}j.prototype.ajax={_contract:["output"],get:function(l){var k,m;m=this;k=function(){m.output+="ASYNC";return l()};return setTimeout(k,5)},addOutput:function(k){return this.output+=k}};j.prototype.afterAsync=function(){return this.ajax.output+="After"};j.prototype.doItAsync=function(){var k=this;this.ajax.get(function(){if(!(k.promise!=null)){throw"Promise should be defined"}if(k.promise.always!=null){return k.promise.resolve()}else{return k.promise.done()}});this.afterAsync();return this.promise};j.prototype.returnPromise=function(){var k=this;this.ajax.output+="Return";this.promise.then(function(){return k.ajax.addOutput("Promise")});return this.promise};j.prototype.customPromise=function(){var l,k=this;l=jQuery.Deferred();l.then(function(){return k.ajax.addOutput("CustomPromise")});return l};return j})(Ivento.Dci.Context);h=null;beforeEach(function(){return h={output:""}});it("should unbind a Context Method if a promise is returned from it and completed",function(){runs(function(){var i;i=new g(h);return i.doItAsync()});waitsFor(function(){return h.output.length>5},50);return runs(function(){return expect(h.output).toEqual("AfterASYNC")})});it("should not unbind the Context Methods if a promise is returned and not completed",function(){var i,j;i=new g(h);j=i.returnPromise();expect(h.output).toEqual("Return");expect(h.get).toBeDefined();runs(function(){return j.resolve()});waitsFor(function(){return h.output==="ReturnPromise"});return runs(function(){return expect(h.get).toBeUndefined()})});it("should not unbind the Context Methods if a custome promise is returned and not completed",function(){var i,j;i=new g(h);j=i.customPromise();expect(h.get).toBeDefined();runs(function(){return j.resolve()});waitsFor(function(){return h.output==="CustomPromise"});return runs(function(){return expect(h.get).toBeUndefined()})});return it("should be able to change promise framework by using an adapter",function(){var i,j,k,l;i=Ivento.Dci.Context;k=i.promise;l=i.unbindPromise;j=i.isPromise;expect(i.promise).not.toBe(i.promiseJsAdapter.factory);expect(i.unbindPromise).not.toBe(i.promiseJsAdapter.unbind);expect(i.isPromise).not.toBe(i.promiseJsAdapter.identify);i.setPromiseAdapter(i.promiseJsAdapter);expect(i.promise).toBe(i.promiseJsAdapter.factory);expect(i.unbindPromise).toBe(i.promiseJsAdapter.unbind);expect(i.isPromise).toBe(i.promiseJsAdapter.identify);runs(function(){var m;m=new g(h);return m.doItAsync()});waitsFor(function(){return h.output.length>5},50);return runs(function(){expect(h.output).toEqual("AfterASYNC");i.promise=k;i.unbindPromise=l;return i.isPromise=j})})});return describe("Unbinding behavior",function(){var i,g,h;g=null;h=null;beforeEach(function(){return g={name:"Clark Kent",useXRay:function(){return"Prevented by glasses."}}});i=(function(j){b(k,j);function k(l){this.bind(l).to("superman")}k.prototype.superman={useXRay:function(){return"wzzzt!"},fly:function(){expect(this).toBe(g);return"wheee!"}};k.prototype.execute=function(){expect(this).toBe(h);return this.superman.fly()};k.prototype.xRay=function(){return this.superman.useXRay()};return k})(Ivento.Dci.Context);it("should remove the role methods from the rolePlayer automatically",function(){h=new i(g);expect(g.useXRay()).toEqual("Prevented by glasses.");expect(g.fly).toBeUndefined();expect(h.superman.name).toBeUndefined();expect(h.xRay()).toEqual("wzzzt!");expect(h.execute()).toEqual("wheee!");return expect(g.fly).toBeUndefined()});return it("should remove special properties from the rolePlayer automatically",function(){h=new i(g);expect(g.context).toBeUndefined();expect(g.promise).toBeUndefined();expect(h.execute()).toEqual("wheee!");expect(g.context).toBeUndefined();return expect(g.promise).toBeUndefined()})})})}).call(this);