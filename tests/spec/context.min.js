(function(){var b={}.hasOwnProperty,a=function(c,f){for(var e in f){if(b.call(f,e)){c[e]=f[e]}}function d(){this.constructor=c}d.prototype=f.prototype;c.prototype=new d();c.__super__=f.prototype;return c};describe("Ivento.Dci.Context",function(){var c,f,d,e;c=(function(g){a(h,g);function h(i){if(i==null){i=[]}this.bind(i).to(this.ledgers)}h.prototype.ledgers={addEntry:function(j,i){return this.push({message:j,amount:i})},getBalance:function(){return this.reduce((function(j,i){return j+i.amount}),0)}};h.prototype.balance=function(){return this.ledgers.getBalance()};h.prototype.increaseBalance=function(i){return this.ledgers.addEntry("Depositing",i)};h.prototype.decreaseBalance=function(i){return this.ledgers.addEntry("Withdrawing",-i)};return h})(Ivento.Dci.Context);f=(function(){function g(h){Ivento.Dci.Context.bind(this,{entries:h}).to(this.ledgers)}g.prototype.ledgers={getBalance:function(){return this.entries.reduce((function(i,h){return i+h.amount}),0)}};g.prototype.balance=function(){return this.ledgers.getBalance()};return g})();d=null;e=null;beforeEach(function(){e=[{message:"Start",amount:100},{message:"First deposit",amount:1000}];return d=new c(e)});describe("Binding behaviour",function(){it("should bind objects to roles using the bind() method",function(){expect(d.ledgers).toBe(e);return expect(d.ledgers.getBalance()).toEqual(1100)});it("should be able to use the context methods",function(){return expect(d.balance()).toEqual(d.ledgers.getBalance())});it("should modify the rolePlayers correctly",function(){d.increaseBalance(200);expect(d.balance()).toEqual(1300);expect(d.ledgers[2]).toEqual({message:"Depositing",amount:200});d.decreaseBalance(1500);expect(d.balance()).toEqual(-200);return expect(d.ledgers[3]).toEqual({message:"Withdrawing",amount:-1500})});return it("should bind to objects not using inheritance with the static method.",function(){var g;g=new f(e);return expect(g.balance()).toEqual(1100)})});describe("MoneyTransfer Context",function(){var g;g=(function(h){a(i,h);function i(l,k,j){this.bind(l).to(this.source);this.bind(k).to(this.destination);this.bind(j).to(this.amount)}i.prototype.source={withdraw:function(j){return this.decreaseBalance(j)},transfer:function(j){this.context.destination.deposit(j);return this.withdraw(j)}};i.prototype.destination={deposit:function(j){return this.increaseBalance(j)}};i.prototype.amount={};i.prototype.transfer=function(){return this.source.transfer(this.amount)};return i})(Ivento.Dci.Context);return it("should transfer money using Accounts",function(){var h,i,j,k;k=new c(e);j=new c;h=200;expect(k.balance()).toEqual(1100);expect(j.balance()).toEqual(0);i=new g(k,j,h);i.transfer();i.unbind();expect(k.balance()).toEqual(900);return expect(j.balance()).toEqual(200)})});describe("Role Contracts",function(){var g;g=(function(h){a(i,h);function i(j,k){this.bind(j).to(this.guests);this.bind(k).to(this.waiter)}i.prototype.waiter={_contract:["name"],greetGuests:function(){return"Welcome, my name is "+this.name+", I'll be your waiter tonight."}};i.prototype.guests={_contract:["add","remove"]};return i})(Ivento.Dci.Context);it("should ensure that the RolePlayer has all contract properties in the _contract array",function(){var h,i,j;j={name:"Henry"};i=[];i.add=i.push;i.remove=function(k){return delete this[k]};h=new g(i,j);expect(h.waiter.greetGuests()).toEqual("Welcome, my name is Henry, I'll be your waiter tonight.");return expect(h.guests.add("Someone")).toEqual(1)});return it("should throw an Exception if the RolePlayer doesn't have all the properties in the _contract array",function(){var h,i;h={};i=[];i.add=i.push;i.remove=function(j){return delete this[j]};return expect(function(){return new g(i,h)}).toThrow("RolePlayer [object Object] didn't fulfill Role Contract with property 'name'.")})});return describe("Unbinding behavior",function(){var h,j,g,i;g=null;i=null;beforeEach(function(){return g={name:"Clark Kent",useXRay:function(){return"Prevented by glasses."}}});h=(function(k){a(l,k);function l(m){}l.prototype.spiderman={useWeb:function(){return"fzzzt!"}};return l})(Ivento.Dci.Context);j=(function(k){a(l,k);function l(m){this.bind(m).to(this.superman)}l.prototype.superman={useXRay:function(){return"wzzzt!"},fly:function(){expect(this).toBe(g);return"wheee!"}};l.prototype.execute=function(){expect(this).toBe(i);return this.superman.fly()};return l})(Ivento.Dci.Context);it("should have an unbind method added after the first bind",function(){var k;k=new h(g);expect(k.unbind).toBeUndefined();i=new j(g);return expect(i.unbind).toBeDefined()});return it("unbind() should remove the role methods from the rolePlayer",function(){i=new j(g);expect(g.useXRay()).toEqual("wzzzt!");expect(g.fly()).toEqual("wheee!");expect(i.superman.name).toBeDefined();i.unbind();expect(g.fly).toBeUndefined();expect(g.useXRay()).toEqual("Prevented by glasses.");expect(i.unbind).toBeUndefined();return expect(i.superman.name).toBeUndefined()})})})}).call(this);